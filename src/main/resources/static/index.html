<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–ç­–ç•¥ç›‘æ§é©¾é©¶èˆ± - åŠ¨é‡ç­–ç•¥ v3.0</title>
    
    <!-- ä½¿ç”¨ unpkg æº -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif; background-color: #f5f7fa; }
        #app { height: 100%; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { background-color: #2c3e50; color: white; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; }
        .header h1 { font-size: 20px; margin: 0; display: flex; align-items: center; gap: 10px; }
        .header .meta-info { font-size: 12px; color: #bdc3c7; }

        /* ä¸»å¸ƒå±€ */
        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        /* å·¦ä¾§åˆ—è¡¨åŒº */
        .left-panel { width: 500px; background: white; border-right: 1px solid #e6e6e6; display: flex; flex-direction: column; z-index: 10; flex-shrink: 0; }
        .filter-bar { padding: 15px; border-bottom: 1px solid #ebeef5; background: #fff; }
        .data-table-container { flex: 1; overflow: hidden; position: relative; } 
        
        /* å³ä¾§å›¾è¡¨åŒº */
        .right-panel { flex: 1; padding: 20px; display: flex; flex-direction: column; background-color: #f0f2f5; overflow-y: auto; overflow-x: hidden; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .chart-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; flex-direction: column; }
        
        /* ä¸ŠåŠéƒ¨åˆ†ï¼šè¶‹åŠ¿å›¾ (å›ºå®šé«˜åº¦) */
        .top-section { height: 550px; flex-shrink: 0; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #ebeef5; padding-bottom: 15px; }
        .etf-title { font-size: 24px; font-weight: bold; color: #303133; }
        .etf-subtitle { color: #909399; font-size: 14px; margin-left: 10px; }
        .stat-tags { display: flex; gap: 15px; margin-top: 10px; }
        
        .chart-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 10px; background: #f9fafc; padding: 10px 20px; border-radius: 4px; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-label { font-weight: bold; color: #606266; font-size: 14px; }

        #trendChart { flex: 1; width: 100%; min-height: 0; } /* min-height 0 for flex child */

        /* ä¸‹åŠéƒ¨åˆ†ï¼šæ·±åº¦åˆ†æåŒº */
        .bottom-section { display: flex; gap: 20px; height: 350px; flex-shrink: 0; }
        
        /* å·¦æ ï¼šé‡åŒ–ä½“æ£€ */
        .analysis-left { flex: 1; display: flex; flex-direction: column; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex: 1; }
        .kpi-item { background: #f8f9fa; border-radius: 6px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .kpi-title { font-size: 13px; color: #909399; margin-bottom: 8px; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #303133; }
        .kpi-desc { font-size: 12px; color: #67c23a; margin-top: 5px; }

        /* å‡çº¿çŸ©é˜µ */
        .ma-matrix { display: flex; gap: 10px; width: 100%; justify-content: space-around; margin-top: 10px; }
        .ma-box { flex: 1; padding: 8px 0; border-radius: 4px; text-align: center; color: white; font-size: 12px; font-weight: bold; opacity: 0.9; }
        .ma-up { background-color: #67c23a; } /* ç«™ä¸Šå‡çº¿ */
        .ma-down { background-color: #f56c6c; } /* è·Œç ´å‡çº¿ */

        /* å³æ ï¼šå…³è”ä¸ä¿¡å· */
        .analysis-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¢œè‰²è¾…åŠ©ç±» */
        .text-red { color: #f56c6c; font-weight: bold; }
        .text-green { color: #67c23a; font-weight: bold; }
        .rank-up { color: #f56c6c; font-weight: bold; } 
        .rank-down { color: #67c23a; font-weight: bold; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #dcdfe6; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f5f7fa; }

        #error-msg { position: fixed; top: 0; left: 0; width: 100%; background: #f56c6c; color: white; padding: 10px; text-align: center; z-index: 9999; display: none; }
    </style>
</head>
<body>
    <div id="error-msg"></div>

    <div id="app">
        <!-- é¡¶éƒ¨ -->
        <div class="header">
            <h1>
                <span>ğŸ“ˆ</span>
                å…¨å¸‚åœº ETF åŠ¨é‡ç›‘æ§çœ‹æ¿
            </h1>
            <div class="meta-info">æ•°æ®æº: å®æ—¶æ•°æ®åº“ | çŠ¶æ€: {{ dataStatus }}</div>
        </div>

        <div class="main-container">
            <!-- å·¦ä¾§ï¼šETF åˆ—è¡¨ -->
            <div class="left-panel">
                <div class="filter-bar">
                    <!-- è‚¡ç¥¨ç±»å‹åˆ‡æ¢ -->
                    <div style="margin-bottom: 15px; text-align: center;">
                        <el-radio-group v-model="stockType" @change="fetchData" size="large">
                            <el-radio-button label="STOCK">è‚¡ç¥¨/ETF</el-radio-button>
                            <el-radio-button label="INDEX">å®½åŸºæŒ‡æ•°</el-radio-button>
                        </el-radio-group>
                    </div>

                    <el-input v-model="searchText" placeholder="æœç´¢ä»£ç /åç§°" style="margin-bottom: 10px;" clearable>
                        <template #prefix>ğŸ”</template>
                    </el-input>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <el-input-number v-model="minAmount" :min="0" :step="1000" placeholder="æœ€å°æˆäº¤é¢(ä¸‡)" style="width: 100%;" :controls="false">
                            <template #prefix>Â¥</template>
                            <template #suffix>ä¸‡</template>
                        </el-input-number>
                        <el-select v-model="exchangeFilter" placeholder="äº¤æ˜“æ‰€" style="width: 100px;">
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option label="SH" value="SH"></el-option>
                            <el-option label="SZ" value="SZ"></el-option>
                        </el-select>
                    </div>
                     <!-- æ—¥æœŸé€‰æ‹© -->
                     <el-date-picker
                        v-model="targetDate"
                        type="date"
                        placeholder="é€‰æ‹©æ•°æ®æ—¥æœŸ"
                        size="default"
                        style="width: 100%;"
                        format="YYYY-MM-DD"
                        value-format="YYYY-MM-DD"
                        @change="fetchData"
                        :disabled-date="disabledDate"
                    />
                </div>

                <div class="data-table-container">
                    <el-table 
                        :data="filteredList" 
                        style="width: 100%; height: 100%;" 
                        highlight-current-row
                        @row-click="handleRowClick"
                        :default-sort="{prop: 'score', order: 'descending'}"
                        v-loading="loading"
                        stripe
                        border
                    >
                        <el-table-column prop="instrumentId" label="ä»£ç " width="80" fixed sortable></el-table-column>
                        <el-table-column prop="instrumentName" label="åç§°" min-width="120" show-overflow-tooltip fixed>
                            <template #default="scope">
                                <div style="font-weight: 600; font-size: 14px;">{{ scope.row.instrumentName }}</div>
                                <div style="font-size: 12px; color: #909399;">{{ scope.row.exchangeId }}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="score" label="Score" width="90" sortable align="right">
                            <template #default="scope">
                                <span style="font-weight: bold; font-size: 15px; color: #303133;">{{ scope.row.score?.toFixed(1) }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="ranking" label="æ’å" width="85" sortable align="center">
                            <template #default="scope">
                                <el-tag size="small" :type="scope.row.ranking <= 10 ? 'danger' : (scope.row.ranking <= 50 ? 'warning' : 'info')" effect="dark" style="font-weight: bold;">
                                    #{{ scope.row.ranking }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="rankingChange" label="å˜åŒ–" width="80" sortable align="right">
                            <template #default="scope">
                                <span v-if="scope.row.rankingChange > 0" class="rank-up">
                                    â¬† {{ scope.row.rankingChange }}
                                </span>
                                <span v-else-if="scope.row.rankingChange < 0" class="rank-down">
                                    â¬‡ {{ Math.abs(scope.row.rankingChange) }}
                                </span>
                                <span v-else style="color: #dcdfe6;">-</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="amount" label="æˆäº¤(äº¿)" width="95" sortable align="right">
                            <template #default="scope">
                                {{ (scope.row.amount / 100000000).toFixed(2) }}
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div style="padding: 10px; text-align: center; border-top: 1px solid #eee; color: #666; font-size: 12px; background: #fff;">
                    å…± {{ filteredList.length }} / {{ etfList.length }} åªæ ‡çš„
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯¦æƒ…ä¸å›¾è¡¨ -->
            <div class="right-panel">
                <template v-if="currentEtf">
                    
                    <!-- 1. é¡¶éƒ¨è¶‹åŠ¿å›¾åŒºåŸŸ -->
                    <div class="chart-card top-section">
                        <div class="card-header">
                            <div>
                                <span class="etf-title">{{ currentEtf.instrumentName }}</span>
                                <span class="etf-subtitle">{{ currentEtf.instrumentId }}.{{ currentEtf.exchangeId }}</span>
                                <div class="stat-tags">
                                    <el-tag effect="dark" type="danger" size="large">å½“å‰æ’å: #{{ currentEtf.ranking }}</el-tag>
                                    <el-tag type="warning" effect="dark" size="large">Score: {{ currentEtf.score?.toFixed(2) }}</el-tag>
                                    <el-tag type="info" effect="plain">æˆäº¤é¢: {{ (currentEtf.amount / 10000).toFixed(0) }}ä¸‡</el-tag>
                                    <el-tag type="success" effect="plain">æ”¶ç›˜ä»·: {{ currentEtf.close }}</el-tag>
                                </div>
                            </div>
                        </div>

                        <!-- äº¤äº’æ§ä»¶ -->
                        <div class="chart-controls">
                            <div class="control-group">
                                <span class="control-label">æŒ‡æ ‡:</span>
                                <el-radio-group v-model="chartMetric" @change="updateChart" size="small">
                                    <el-radio-button label="score">åŠ¨é‡å¾—åˆ†</el-radio-button>
                                    <el-radio-button label="ranking">å…¨å¸‚åœºæ’å</el-radio-button>
                                    <el-radio-button label="amount">æˆäº¤é‡‘é¢</el-radio-button>
                                </el-radio-group>
                            </div>
                            
                            <div class="control-group">
                                <span class="control-label">å†å²èŒƒå›´:</span>
                                <el-radio-group v-model="quickTimeRange" @change="handleQuickTimeChange" size="small">
                                    <el-radio-button :label="7">7å¤©</el-radio-button>
                                    <el-radio-button :label="30">30å¤©</el-radio-button>
                                    <el-radio-button :label="60">60å¤©</el-radio-button>
                                    <el-radio-button :label="90">90å¤©</el-radio-button>
                                    <el-radio-button :label="365">1å¹´</el-radio-button>
                                </el-radio-group>
                            </div>
                        </div>

                        <div id="trendChart" v-loading="chartLoading"></div>
                    </div>

                    <!-- 2. åº•éƒ¨æ·±åº¦åˆ†æåŒºåŸŸ -->
                    <div class="bottom-section">
                        <!-- å·¦ä¸‹ï¼šé‡åŒ–ä½“æ£€ -->
                        <div class="chart-card analysis-left">
                            <h3 style="margin:0 0 15px 0; font-size: 16px; border-left: 4px solid #409eff; padding-left: 10px;">ğŸ›¡ï¸ é‡åŒ–ä½“æ£€æŠ¥å‘Š (åŸºäºå†å²æ•°æ®)</h3>
                            
                            <div class="kpi-grid">
                                <div class="kpi-item">
                                    <div class="kpi-title">è¿‘ {{ quickTimeRange }} å¤©æœ€å¤§å›æ’¤</div>
                                    <div class="kpi-value text-red">{{ currentMetrics.drawdown }}%</div>
                                    <div class="kpi-desc">æœ€é«˜ä»·: {{ currentMetrics.highPrice }}</div>
                                </div>
                                <div class="kpi-item">
                                    <div class="kpi-title">å‡çº¿è¶‹åŠ¿</div>
                                     <div class="kpi-value" :class="currentMetrics.isUpTrend ? 'text-red' : 'text-green'">
                                        {{ currentMetrics.isUpTrend ? 'å¤šå¤´' : 'ç©ºå¤´' }}
                                    </div>
                                    <div class="kpi-desc">MA20 vs MA60</div>
                                </div>
                            </div>

                            <div style="margin-top: 15px;">
                                <div class="kpi-title">å‡çº¿çŠ¶æ€çŸ©é˜µ (MA Status)</div>
                                <div class="ma-matrix">
                                    <div class="ma-box" :class="currentMetrics.ma5 ? 'ma-up' : 'ma-down'">MA5</div>
                                    <div class="ma-box" :class="currentMetrics.ma10 ? 'ma-up' : 'ma-down'">MA10</div>
                                    <div class="ma-box" :class="currentMetrics.ma20 ? 'ma-up' : 'ma-down'">MA20</div>
                                    <div class="ma-box" :class="currentMetrics.ma60 ? 'ma-up' : 'ma-down'">MA60</div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #999;">
                                    {{ currentMetrics.trendSummary }}
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¸‹ï¼šå†å²è®°å½•åˆ—è¡¨ -->
                         <div class="chart-card analysis-right">
                             <h3 style="margin:0 0 10px 0; font-size: 16px;">ğŸ“… å†å²æ•°æ®æ¦‚è§ˆ</h3>
                             <el-table :data="historyList" style="width: 100%" height="250" size="small" stripe>
                                 <el-table-column prop="targetDate" label="æ—¥æœŸ" width="100">
                                     <template #default="scope">{{ formatDateSimple(scope.row.targetDate) }}</template>
                                 </el-table-column>
                                 <el-table-column prop="close" label="æ”¶ç›˜" width="70"></el-table-column>
                                 <el-table-column prop="score" label="Score" width="70"></el-table-column>
                                 <el-table-column prop="ranking" label="æ’å" width="60"></el-table-column>
                                 <el-table-column prop="rankingChange" label="å˜åŠ¨" align="right">
                                    <template #default="scope">
                                        <span :class="scope.row.rankingChange > 0 ? 'rank-up' : (scope.row.rankingChange < 0 ? 'rank-down' : '')">
                                            {{ scope.row.rankingChange }}
                                        </span>
                                    </template>
                                 </el-table-column>
                             </el-table>
                        </div>
                    </div>
                </template>

                <div v-else class="chart-card" style="height: 100%; justify-content: center; align-items: center; color: #999;">
                    <el-empty description="ğŸ‘ˆ è¯·åœ¨å·¦ä¾§åˆ—è¡¨ä¸­ç‚¹å‡»ä»»ä¸€ ETFï¼ŒæŸ¥çœ‹å¤šç»´æ·±åº¦åˆ†æ"></el-empty>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        const app = createApp({
            setup() {
                const loading = ref(false);
                const chartLoading = ref(false);
                const etfList = ref([]);
                const searchText = ref('');
                const minAmount = ref(0);
                const exchangeFilter = ref('');
                const currentEtf = ref(null);
                const targetDate = ref(''); // å½“å‰é€‰ä¸­çš„æ—¥æœŸ
                const stockType = ref('STOCK'); // é»˜è®¤ä¸ºè‚¡ç¥¨
                const dataStatus = ref('åˆå§‹åŒ–ä¸­...');
                
                // çŠ¶æ€å˜é‡
                const chartMetric = ref('score'); 
                const quickTimeRange = ref(90); 
                const historyList = ref([]); // å½“å‰é€‰ä¸­ ETF çš„å†å²æ•°æ®

                // é‡åŒ–æŒ‡æ ‡æ•°æ®
                const currentMetrics = ref({
                    drawdown: 0,
                    highPrice: 0,
                    isUpTrend: false,
                    ma5: false, ma10: false, ma20: false, ma60: false,
                    trendSummary: '-'
                });

                let myChart = null;

                // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    return d.toISOString().split('T')[0];
                };

                const formatDateSimple = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                // è·å–æœ€æ–°çš„æ•°æ®æ—¥æœŸ
                const fetchLatestData = async () => {
                    loading.value = true;
                    dataStatus.value = 'åŠ è½½æœ€æ–°æ•°æ®...';
                    try {
                        // é¦–å…ˆå°è¯•ç›´æ¥è·å– /latest
                        const response = await axios.get('/api/stock-analysis/latest');
                        if (response.data && response.data.length > 0) {
                            etfList.value = response.data;
                            // ä»ç¬¬ä¸€æ¡æ•°æ®è·å–æ—¥æœŸ
                            if (etfList.value[0].targetDate) {
                                targetDate.value = formatDateSimple(etfList.value[0].targetDate);
                            }
                            dataStatus.value = 'åœ¨çº¿';
                        } else {
                            dataStatus.value = 'æ— æ•°æ®';
                            etfList.value = [];
                        }
                    } catch (error) {
                        console.error('Fetch latest failed', error);
                        dataStatus.value = 'è¿æ¥å¤±è´¥';
                        document.getElementById('error-msg').innerText = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥: ' + error.message;
                        document.getElementById('error-msg').style.display = 'block';
                    } finally {
                        loading.value = false;
                    }
                };

                // æ ¹æ®æ—¥æœŸè·å–æ•°æ®
                const fetchData = async () => {
                    if (!targetDate.value) return;
                    loading.value = true;
                    try {
                        const response = await axios.get('/api/stock-analysis/search', {
                            params: { 
                                targetDate: targetDate.value,
                                stockType: stockType.value 
                            }
                        });
                        etfList.value = response.data;
                    } catch (error) {
                        console.error('Fetch data failed', error);
                         this.$message.error('è·å–æ•°æ®å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };

                // è·å–å•ä¸ª ETF çš„å†å²æ•°æ®
                const fetchHistory = async (exchangeId, instrumentId) => {
                    chartLoading.value = true;
                    try {
                        const response = await axios.get('/api/stock-analysis/search', {
                            params: { 
                                exchangeId, 
                                instrumentId 
                            }
                        });
                        // æŒ‰æ—¥æœŸæ’åº
                        const data = response.data.sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
                        historyList.value = [...data].reverse(); // åˆ—è¡¨æ˜¾ç¤ºå€’åºï¼Œä½¿ç”¨å‰¯æœ¬ä¸å½±å“åŸæ•°æ®
                        
                        // è®¡ç®—æŒ‡æ ‡å¹¶ç»˜å›¾ï¼ˆä½¿ç”¨æ­£åºæ•°æ®ï¼‰
                        updateChartAndMetrics(data);
                    } catch (error) {
                        console.error('Fetch history failed', error);
                    } finally {
                        chartLoading.value = false;
                    }
                };

                const filteredList = computed(() => {
                    return etfList.value.filter(item => {
                        // å…¼å®¹æ—§æ•°æ®ï¼ˆæ²¡æœ‰ stockType å­—æ®µçš„é»˜è®¤ä¸º STOCKï¼‰
                        const itemType = item.stockType || 'STOCK';
                        const matchType = itemType === stockType.value;
                        
                        const matchText = !searchText.value || 
                            item.instrumentId.includes(searchText.value) || 
                            item.instrumentName.includes(searchText.value);
                        const matchAmount = (item.amount || 0) >= minAmount.value * 10000;
                        const matchEx = !exchangeFilter.value || item.exchangeId === exchangeFilter.value;
                        
                        return matchType && matchText && matchAmount && matchEx;
                    });
                });

                // è®¡ç®— MA
                const calculateMA = (data, dayCount) => {
                    const result = [];
                    for (let i = 0; i < data.length; i++) {
                        if (i < dayCount - 1) {
                            result.push(null);
                            continue;
                        }
                        let sum = 0;
                        for (let j = 0; j < dayCount; j++) {
                            sum += data[i - j].close;
                        }
                        result.push(sum / dayCount);
                    }
                    return result;
                };

                const updateChartAndMetrics = (rawHistory) => {
                    // 0. å¤åˆ¶å¹¶å¼ºåˆ¶ç¡®ä¿æ•°æ®æŒ‰æ—¥æœŸæ­£åºæ’åˆ— (æ—§ -> æ–°)
                    const fullHistory = [...rawHistory].sort((a, b) => {
                        return new Date(a.targetDate).getTime() - new Date(b.targetDate).getTime();
                    });

                    // 1. è¿‡æ»¤æ—¶é—´èŒƒå›´
                    let endDate = new Date();
                    if (targetDate.value) {
                         // å¦‚æœæœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œä½¿ç”¨é€‰ä¸­æ—¥æœŸä½œä¸ºç»“æŸæ—¥æœŸ
                        endDate = new Date(targetDate.value);
                    }
                    
                    const startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - quickTimeRange.value);

                    // ç­›é€‰ [startDate, endDate] èŒƒå›´å†…çš„æ•°æ®
                    // æ³¨æ„ï¼šfullHistory ä¸­çš„ targetDate å¯èƒ½æ˜¯ UTC å­—ç¬¦ä¸²ï¼Œæ¯”è¾ƒæ—¶éœ€è½¬ Date
                    const data = fullHistory.filter(item => {
                        const d = new Date(item.targetDate);
                        // åªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶åˆ†ç§’å·®å¼‚ (ç®€å•å¤„ç†: è½¬æ—¶é—´æˆ³æ¯”è¾ƒ)
                        return d.getTime() >= startDate.getTime() && d.getTime() <= endDate.getTime() + 86400000; // +1å¤©ä»¥åŒ…å«å½“å¤©
                    });
                    
                    if (data.length === 0) return;

                    const dates = data.map(item => formatDateSimple(item.targetDate));
                    const prices = data.map(item => item.close);
                    
                    // 2. è®¡ç®—æŒ‡æ ‡
                    const maxPrice = Math.max(...prices);
                    const currentPrice = prices[prices.length - 1];
                    const drawdown = ((currentPrice - maxPrice) / maxPrice * 100).toFixed(2);
                    
                    // ç®€å• MA è®¡ç®— (åŸºäºå®Œæ•´å†å²ä»¥ä¿è¯å‡†ç¡®æ€§ï¼Œç„¶åæˆªå–)
                    // ... (rest of the function)
                    const closes = fullHistory.map(d => d.close);
                    const ma5Full = calculateMA(fullHistory, 5);
                    const ma10Full = calculateMA(fullHistory, 10);
                    const ma20Full = calculateMA(fullHistory, 20);
                    const ma60Full = calculateMA(fullHistory, 60);

                    // è·å–æœ€åä¸€ä¸ªç‚¹çš„çŠ¶æ€
                    const lastIdx = fullHistory.length - 1;
                    const lastClose = closes[lastIdx];
                    
                    currentMetrics.value = {
                        drawdown: drawdown,
                        highPrice: maxPrice.toFixed(3),
                        isUpTrend: (ma20Full[lastIdx] > ma60Full[lastIdx]), // ç®€å•å®šä¹‰
                        ma5: lastClose > ma5Full[lastIdx],
                        ma10: lastClose > ma10Full[lastIdx],
                        ma20: lastClose > ma20Full[lastIdx],
                        ma60: lastClose > ma60Full[lastIdx],
                        trendSummary: (lastClose > ma20Full[lastIdx] && ma20Full[lastIdx] > ma60Full[lastIdx]) ? 'å¤šå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸Š' : 'è¶‹åŠ¿éœ‡è¡æˆ–å›è°ƒä¸­'
                    };

                    // 3. ç»˜å›¾æ•°æ®å‡†å¤‡
                    const metricMap = {
                        'score': { name: 'åŠ¨é‡å¾—åˆ†', data: data.map(i => i.score), color: '#e6a23c', inverse: false, type: 'line', area: true },
                        'ranking': { name: 'å…¨å¸‚åœºæ’å', data: data.map(i => i.ranking), color: '#f56c6c', inverse: true, type: 'line', area: false }, 
                        'amount': { name: 'æˆäº¤é‡‘é¢', data: data.map(i => i.amount), color: '#409eff', inverse: false, type: 'bar', area: false }
                    };
                    const selected = metricMap[chartMetric.value];

                    const option = {
                        title: { text: `${dates[0]} è‡³ ${dates[dates.length-1]} è¶‹åŠ¿`, left: 'center', textStyle: { fontSize: 14, color: '#999' } },
                        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                        grid: { right: '15%', left: '8%', bottom: '10%', top: '15%' },
                        legend: { data: ['æ”¶ç›˜ä»·', selected.name], top: 25 },
                        xAxis: { type: 'category', data: dates, axisLine: { lineStyle: { color: '#ccc' } } },
                        yAxis: [
                            { type: 'value', name: 'æ”¶ç›˜ä»·', position: 'left', scale: true, splitLine: { show: true, lineStyle: { type: 'dashed' } } },
                            { type: 'value', name: selected.name, position: 'right', scale: true, inverse: selected.inverse, axisLine: { show: true, lineStyle: { color: selected.color } }, axisLabel: { color: selected.color }, splitLine: { show: false } }
                        ],
                        series: [
                            { name: 'æ”¶ç›˜ä»·', type: 'line', data: prices, yAxisIndex: 0, showSymbol: false, itemStyle: { color: '#303133' }, lineStyle: { width: 3 } },
                            { name: selected.name, type: selected.type, data: selected.data, yAxisIndex: 1, showSymbol: false, itemStyle: { color: selected.color }, areaStyle: selected.area ? { opacity: 0.2 } : null }
                        ]
                    };
                    
                    if (myChart) {
                        myChart.setOption(option, true);
                    }
                };

                const updateChart = () => {
                   // è§¦å‘é‡æ–°ç»˜å›¾ï¼ˆåˆ©ç”¨å·²æœ‰æ•°æ®ï¼‰
                   // è¿™é‡Œéœ€è¦ç¼“å­˜ fetchHistory çš„æ•°æ®ï¼Œæš‚ç•¥ï¼Œç®€å•èµ·è§é‡æ–° fetch æˆ– ä¾èµ– historyList
                   // ä¸ºç®€å•èµ·è§ï¼Œä» historyList (å€’åº) æ¢å¤æ­£åºå¹¶é‡ç»˜
                   if (historyList.value.length > 0) {
                       const sorted = [...historyList.value].reverse();
                       updateChartAndMetrics(sorted);
                   }
                };

                const handleQuickTimeChange = () => {
                    updateChart();
                };

                const handleRowClick = (row) => {
                    currentEtf.value = row;
                    fetchHistory(row.exchangeId, row.instrumentId);

                    nextTick(() => {
                        if (!myChart) {
                            myChart = echarts.init(document.getElementById('trendChart'));
                            window.addEventListener('resize', () => myChart.resize());
                        }
                    });
                };

                const disabledDate = (time) => {
                    return time.getTime() > Date.now();
                }

                onMounted(() => {
                    fetchLatestData();
                });

                return {
                    loading, chartLoading, etfList, filteredList, searchText, minAmount, exchangeFilter, currentEtf,
                    chartMetric, quickTimeRange, targetDate, dataStatus, stockType,
                    currentMetrics, historyList,
                    handleRowClick, updateChart, handleQuickTimeChange, fetchData, disabledDate, formatDateSimple
                };
            }
        });

        app.use(ElementPlus, { locale: ElementPlusLocaleZhCn }); 
        app.mount('#app');
    </script>
</body>
</html>

