<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡åŒ–ç­–ç•¥ç›‘æ§é©¾é©¶èˆ± - åŠ¨é‡ç­–ç•¥ v3.0</title>
    
    <!-- ä½¿ç”¨ unpkg æº -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-md: 12px;
        }

        html, body { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }
        #app { height: 100%; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨å¯¼èˆª - ç°ä»£åŒ–ç»ç’ƒæ‹Ÿæ€/æ¸å˜é£æ ¼ */
        .header { 
            background: var(--card-bg);
            padding: 0 24px; 
            height: 64px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: var(--shadow-sm); 
            flex-shrink: 0; 
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 { 
            font-size: 22px; 
            margin: 0; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        /* Logo æ–‡å­—æ¸å˜ */
        .brand-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header .meta-info { 
            font-size: 13px; 
            color: var(--text-sub); 
            background: #f9fafb;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
        }

        /* ä¸»å¸ƒå±€ */
        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        /* å·¦ä¾§åˆ—è¡¨åŒº */
        .left-panel { 
            background: var(--card-bg); 
            border-right: 1px solid #e5e7eb; 
            display: flex; 
            flex-direction: column; 
            z-index: 10; 
            flex-shrink: 0; 
            min-width: 0;
            will-change: width;
            box-shadow: 2px 0 8px rgba(0,0,0,0.02);
        }
        
        /* æ‹–æ‹½åˆ†å‰²æ¡ - æ›´åŠ æ˜æ˜¾ä¸”ä¼˜é›… */
        .resizer {
            width: 6px;
            cursor: col-resize;
            background: #f3f4f6;
            flex-shrink: 0;
            transition: all 0.2s;
            z-index: 20;
            position: relative;
        }
        .resizer::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 2px; height: 20px;
            background: #d1d5db;
            border-radius: 2px;
        }
        .resizer:hover, .resizer.active {
            background: #dbeafe; /* Light blue */
        }
        .resizer:hover::after, .resizer.active::after {
            background: var(--primary-color);
        }

        .filter-bar { padding: 20px; border-bottom: 1px solid #f3f4f6; background: #fff; }
        .data-table-container { flex: 1; overflow: hidden; position: relative; } 
        
        /* å³ä¾§å›¾è¡¨åŒº */
        .right-panel { 
            flex: 1; 
            padding: 24px; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-color); 
            overflow-y: auto; 
            overflow-x: hidden; 
            min-width: 0; 
            gap: 24px;
        }
        
        /* å¡ç‰‡ç°ä»£åŒ–æ ·å¼ */
        .chart-card { 
            background: var(--card-bg); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm); 
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column; 
        }
        .chart-card:hover {
            box-shadow: var(--shadow-md);
            /* transform: translateY(-2px); ç¨å¾®ä¸Šæµ®ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
        }
        
        /* ä¸ŠåŠéƒ¨åˆ†ï¼šè¶‹åŠ¿å›¾ */
        .top-section { height: 580px; flex-shrink: 0; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid #f3f4f6; padding-bottom: 16px; }
        .etf-title { font-size: 26px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .etf-subtitle { color: var(--text-sub); font-size: 15px; margin-left: 12px; font-weight: 500; }
        .stat-tags { display: flex; gap: 12px; margin-top: 12px; }
        
        .chart-controls { 
            display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px; 
            background: #f8fafc; padding: 12px 20px; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .control-group { display: flex; align-items: center; gap: 12px; }
        .control-label { font-weight: 600; color: #4b5563; font-size: 14px; }

        #trendChart { flex: 1; width: 100%; min-height: 0; border-radius: 8px; }

        /* ä¸‹åŠéƒ¨åˆ†ï¼šæ·±åº¦åˆ†æåŒº */
        .bottom-section { display: flex; gap: 24px; height: 380px; flex-shrink: 0; }
        
        /* å·¦æ ï¼šé‡åŒ–ä½“æ£€ */
        .analysis-left { flex: 1; display: flex; flex-direction: column; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; flex: 1; }
        .kpi-item { 
            background: #f9fafb; 
            border-radius: 12px; 
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            transition: background 0.3s;
        }
        .kpi-item:hover { background: #eff6ff; }
        .kpi-title { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500; }
        .kpi-value { font-size: 28px; font-weight: 800; color: #111827; letter-spacing: -1px; }
        .kpi-desc { font-size: 12px; color: #10b981; margin-top: 6px; font-weight: 600; background: #ecfdf5; padding: 2px 8px; border-radius: 10px; }

        /* å‡çº¿çŸ©é˜µ */
        .ma-matrix { display: flex; gap: 12px; width: 100%; justify-content: space-around; margin-top: 16px; }
        .ma-box { 
            flex: 1; padding: 10px 0; border-radius: 8px; text-align: center; 
            color: white; font-size: 13px; font-weight: 700; opacity: 1; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ma-up { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); } /* é²œäº®ç»¿ */
        .ma-down { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); } /* é²œäº®çº¢ */

        /* å³æ ï¼šå…³è”ä¸ä¿¡å· */
        .analysis-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¢œè‰²è¾…åŠ©ç±» */
        .text-red { color: #ef4444; font-weight: bold; }
        .text-green { color: #10b981; font-weight: bold; }
        .rank-up { color: #ef4444; font-weight: bold; } 
        .rank-down { color: #10b981; font-weight: bold; }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .el-table { --el-table-header-bg-color: #f9fafb; --el-table-row-hover-bg-color: #eff6ff !important; border-radius: 8px; overflow: hidden; }
        .el-table th.el-table__cell { font-weight: 600; color: #374151; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        ::-webkit-scrollbar-track { background: transparent; }

        #error-msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fee2e2; color: #b91c1c; padding: 12px 24px; border-radius: 30px; border: 1px solid #fecaca; box-shadow: var(--shadow-lg); z-index: 9999; display: none; font-weight: 500; }
        
        /* é“¾æ¥æ ·å¼ */
        .header-link { font-weight: 500; transition: color 0.2s; }
        .header-link:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div id="error-msg"></div>

    <div id="app">
        <!-- é¡¶éƒ¨ -->
        <div class="header">
            <h1>
                <span style="font-size: 28px;">ğŸ“ˆ</span>
                <span class="brand-text">QTFund åŠ¨é‡ç­–ç•¥ç›‘æ§</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 20px; font-size: 14px; font-weight: 500;">
                <div class="meta-info">âš¡ å®æ—¶æ•°æ® | {{ dataStatus }}</div>
                <span v-if="currentUser.username" style="color: var(--text-main); display: flex; align-items: center;">
                    <el-avatar :size="28" style="margin-right: 8px; background: var(--primary-gradient);">{{ currentUser.username.charAt(0).toUpperCase() }}</el-avatar>
                    {{ currentUser.username }}
                </span>
                <el-link v-if="isAdmin" type="primary" :underline="false" href="/user_management.html" class="header-link" style="color: var(--primary-color);">ç”¨æˆ·ç®¡ç†</el-link>
                <el-link type="info" :underline="false" href="/logout" class="header-link" style="color: #9ca3af;">é€€å‡º</el-link>
            </div>
        </div>

        <div class="main-container" @mousemove="handleMouseMove" @mouseup="handleMouseUp" @mouseleave="handleMouseUp">
            <!-- å·¦ä¾§ï¼šETF åˆ—è¡¨ -->
            <div class="left-panel" :style="{ width: leftPanelWidth + 'px' }" v-show="leftPanelWidth > 0">
                <div class="filter-bar">
                    <!-- è‚¡ç¥¨ç±»å‹åˆ‡æ¢ -->
                    <div style="margin-bottom: 15px; text-align: center;">
                        <el-radio-group v-model="stockType" @change="fetchLatestData" size="large">
                            <el-radio-button label="STOCK">è‚¡ç¥¨/ETF</el-radio-button>
                            <el-radio-button label="INDEX">å®½åŸºæŒ‡æ•°</el-radio-button>
                        </el-radio-group>
                    </div>

                    <el-input v-model="searchText" placeholder="æœç´¢ä»£ç /åç§°" style="margin-bottom: 10px;" clearable>
                        <template #prefix>ğŸ”</template>
                    </el-input>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <!-- è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ -->
                        <div style="width: 110px;">
                            <el-select v-model="selectedTimeRange" placeholder="èŒƒå›´" @change="handleTimeRangeChange">
                                <el-option label="7å¤©" :value="7"></el-option>
                                <el-option label="15å¤©" :value="15"></el-option>
                                <el-option label="30å¤©" :value="30"></el-option>
                                <el-option label="è‡ªå®šä¹‰" value="custom"></el-option>
                            </el-select>
                        </div>
                        <!-- å¦‚æœé€‰äº†è‡ªå®šä¹‰ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†è¦†ç›–é»˜è®¤ Selectï¼Œæˆ–è€…å¼¹çª—ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼šå¦‚æœæ˜¯customæ˜¾ç¤ºè¾“å…¥æ¡† -->
                        <el-input-number v-if="selectedTimeRange === 'custom'" v-model="customTimeRange" :min="1" :max="365" controls-position="right" style="width: 80px;" placeholder="å¤©"></el-input-number>

                        <el-input-number v-model="minAmount" :min="0" :step="1000" placeholder="æœ€å°æˆäº¤(ä¸‡)" style="flex: 1; min-width: 100px;" :controls="false">
                            <template #suffix>ä¸‡</template>
                        </el-input-number>
                        <el-select v-model="exchangeFilter" placeholder="äº¤æ˜“æ‰€" style="width: 80px;">
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option label="SH" value="SH"></el-option>
                            <el-option label="SZ" value="SZ"></el-option>
                        </el-select>
                    </div>
                     <!-- æ—¥æœŸé€‰æ‹© -->
                     <el-date-picker
                        v-model="targetDate"
                        type="date"
                        placeholder="é€‰æ‹©æ•°æ®æ—¥æœŸ"
                        size="default"
                        style="width: 100%;"
                        format="YYYY-MM-DD"
                        value-format="YYYY-MM-DD"
                        @change="fetchData"
                        :disabled-date="disabledDate"
                    />
                </div>

                <div class="data-table-container">
                    <el-table 
                        ref="dataTableRef"
                        :data="filteredList" 
                        style="width: 100%; height: 100%;" 
                        highlight-current-row
                        @row-click="handleRowClick"
                        :default-sort="{prop: 'score', order: 'descending'}"
                        v-loading="loading"
                        stripe
                        border
                    >
                        <el-table-column prop="instrumentId" label="ä»£ç " min-width="80" fixed sortable></el-table-column>
                        <el-table-column prop="instrumentName" label="åç§°" min-width="120" show-overflow-tooltip fixed>
                            <template #default="scope">
                                <div style="font-weight: 600; font-size: 14px;">{{ scope.row.instrumentName }}</div>
                                <div style="font-size: 12px; color: #909399;">{{ scope.row.exchangeId }}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="score" label="Score" min-width="90" sortable align="right">
                            <template #default="scope">
                                <span style="font-weight: bold; font-size: 15px; color: #303133;">{{ scope.row.score?.toFixed(1) }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="ranking" label="æ’å" min-width="85" sortable align="center">
                            <template #default="scope">
                                <el-tag size="small" :type="scope.row.ranking <= 10 ? 'danger' : (scope.row.ranking <= 50 ? 'warning' : 'info')" effect="dark" style="font-weight: bold;">
                                    #{{ scope.row.ranking }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="rankingChange" label="å˜åŒ–" min-width="80" sortable align="right">
                            <template #default="scope">
                                <span v-if="scope.row.rankingChange > 0" class="rank-up">
                                    â¬† {{ scope.row.rankingChange }}
                                </span>
                                <span v-else-if="scope.row.rankingChange < 0" class="rank-down">
                                    â¬‡ {{ Math.abs(scope.row.rankingChange) }}
                                </span>
                                <span v-else style="color: #dcdfe6;">-</span>
                            </template>
                        </el-table-column>
                        <!-- æ–°å¢ä¸‰åˆ—ï¼šè¿ç»­ä¸Šæ¶¨ã€ç´¯è®¡æ¶¨å¹…ã€å‘¨æœŸæ’åå˜åŒ– -->
                        <el-table-column prop="consecutiveRisingDays" label="è¿æ¶¨" min-width="70" sortable align="center">
                            <template #default="scope">
                                <span v-if="scope.row.consecutiveRisingDays > 0" style="color: #f56c6c; font-weight: bold;">
                                    {{ scope.row.consecutiveRisingDays }}å¤©
                                </span>
                                <span v-else style="color: #999;">-</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="cumulativeIncrease" label="ç´¯æ¶¨" min-width="80" sortable align="right">
                            <template #default="scope">
                                <span v-if="scope.row.cumulativeIncrease > 0" style="color: #f56c6c;">
                                    +{{ scope.row.cumulativeIncrease }}%
                                </span>
                                <span v-else-if="scope.row.cumulativeIncrease < 0" style="color: #67c23a;">
                                    {{ scope.row.cumulativeIncrease }}%
                                </span>
                                <span v-else>-</span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="periodRankingChange" label="å‘¨æœŸå‡" min-width="80" sortable align="right">
                            <template #default="scope">
                                <span v-if="scope.row.periodRankingChange > 0" class="rank-up">
                                    â¬† {{ scope.row.periodRankingChange }}
                                </span>
                                <span v-else-if="scope.row.periodRankingChange < 0" class="rank-down">
                                    â¬‡ {{ Math.abs(scope.row.periodRankingChange) }}
                                </span>
                                <span v-else>-</span>
                            </template>
                        </el-table-column>
                        
                        <el-table-column prop="amount" label="æˆäº¤(äº¿)" min-width="95" sortable align="right">
                            <template #default="scope">
                                {{ (scope.row.amount / 100000000).toFixed(2) }}
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div style="padding: 10px; text-align: center; border-top: 1px solid #eee; color: #666; font-size: 12px; background: #fff;">
                    å…± {{ filteredList.length }} / {{ etfList.length }} åªæ ‡çš„
                </div>
            </div>

            <!-- åˆ†å‰²æ¡ -->
            <div class="resizer" 
                 @mousedown.prevent="handleMouseDown" 
                 @dblclick="togglePanel"
                 :class="{ active: isResizing }"
                 title="å·¦å³æ‹–æ‹½è°ƒæ•´å¤§å°ï¼ŒåŒå‡»åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼">
            </div>

            <!-- å³ä¾§ï¼šè¯¦æƒ…ä¸å›¾è¡¨ -->
            <div class="right-panel" v-show="rightPanelVisible">
                <template v-if="currentEtf">
                    
                    <!-- 1. é¡¶éƒ¨è¶‹åŠ¿å›¾åŒºåŸŸ -->
                    <div class="chart-card top-section">
                        <div class="card-header">
                            <div>
                                <span class="etf-title">{{ currentEtf.instrumentName }}</span>
                                <span class="etf-subtitle">{{ currentEtf.instrumentId }}.{{ currentEtf.exchangeId }}</span>
                                <div class="stat-tags">
                                    <el-tag effect="dark" type="danger" size="large">å½“å‰æ’å: #{{ currentEtf.ranking }}</el-tag>
                                    <el-tag type="warning" effect="dark" size="large">Score: {{ currentEtf.score?.toFixed(2) }}</el-tag>
                                    <el-tag type="info" effect="plain">æˆäº¤é¢: {{ (currentEtf.amount / 10000).toFixed(0) }}ä¸‡</el-tag>
                                    <el-tag type="success" effect="plain">æ”¶ç›˜ä»·: {{ currentEtf.close?.toFixed(3) }}</el-tag>
                                </div>
                            </div>
                        </div>

                        <!-- äº¤äº’æ§ä»¶ -->
                        <div class="chart-controls">
                            <div class="control-group">
                                <span class="control-label">æŒ‡æ ‡:</span>
                                <el-radio-group v-model="chartMetric" @change="updateChart" size="small">
                                    <el-radio-button label="score">åŠ¨é‡å¾—åˆ†</el-radio-button>
                                    <el-radio-button label="ranking">å…¨å¸‚åœºæ’å</el-radio-button>
                                    <el-radio-button label="amount">æˆäº¤é‡‘é¢</el-radio-button>
                                </el-radio-group>
                            </div>
                            
                            <div class="control-group">
                                <span class="control-label">å†å²èŒƒå›´:</span>
                                <el-radio-group v-model="quickTimeRange" @change="handleQuickTimeChange" size="small">
                                    <el-radio-button :label="7">7å¤©</el-radio-button>
                                    <el-radio-button :label="30">30å¤©</el-radio-button>
                                    <el-radio-button :label="60">60å¤©</el-radio-button>
                                    <el-radio-button :label="90">90å¤©</el-radio-button>
                                    <el-radio-button :label="365">1å¹´</el-radio-button>
                                </el-radio-group>
                            </div>

                            <div class="control-group" style="margin-left: auto;">
                                <span class="control-label">å¯¹æ¯”:</span>
                                <el-select
                                    v-model="compareList"
                                    multiple
                                    filterable
                                    remote
                                    reserve-keyword
                                    placeholder="æœç´¢å¹¶æ·»åŠ å¯¹æ¯”..."
                                    :remote-method="remoteSearchCompare"
                                    :loading="compareLoading"
                                    @change="handleCompareChange"
                                    @remove-tag="handleRemoveCompare"
                                    style="width: 240px"
                                    size="small"
                                >
                                    <el-option
                                        v-for="item in compareOptions"
                                        :key="item.instrumentId"
                                        :label="item.instrumentName"
                                        :value="item.instrumentId"
                                    >
                                        <span style="float: left">{{ item.instrumentName }}</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">{{ item.instrumentId }}</span>
                                    </el-option>
                                </el-select>
                            </div>
                        </div>

                        <div id="trendChart" v-loading="chartLoading"></div>
                    </div>

                    <!-- 2. åº•éƒ¨æ·±åº¦åˆ†æåŒºåŸŸ -->
                    <div class="bottom-section">
                        <!-- å·¦ä¸‹ï¼šé‡åŒ–ä½“æ£€ -->
                        <div class="chart-card analysis-left">
                            <h3 style="margin:0 0 15px 0; font-size: 16px; border-left: 4px solid #409eff; padding-left: 10px;">ğŸ›¡ï¸ é‡åŒ–ä½“æ£€æŠ¥å‘Š (åŸºäºå†å²æ•°æ®)</h3>
                            
                            <div class="kpi-grid">
                                <div class="kpi-item">
                                    <div class="kpi-title">è¿‘ {{ quickTimeRange }} å¤©æœ€å¤§å›æ’¤</div>
                                    <div class="kpi-value text-red">{{ Number(currentMetrics.drawdown).toFixed(3) }}%</div>
                                    <div class="kpi-desc">æœ€é«˜ä»·: {{ Number(currentMetrics.highPrice).toFixed(3) }}</div>
                                </div>
                                <div class="kpi-item">
                                    <div class="kpi-title">å‡çº¿è¶‹åŠ¿</div>
                                     <div class="kpi-value" :class="currentMetrics.isUpTrend ? 'text-red' : 'text-green'">
                                        {{ currentMetrics.isUpTrend ? 'å¤šå¤´' : 'ç©ºå¤´' }}
                                    </div>
                                    <div class="kpi-desc">MA20 vs MA60</div>
                                </div>
                            </div>

                            <div style="margin-top: 15px;">
                                <div class="kpi-title">å‡çº¿çŠ¶æ€çŸ©é˜µ (MA Status)</div>
                                <div class="ma-matrix">
                                    <div class="ma-box" :class="currentMetrics.ma5 ? 'ma-up' : 'ma-down'">MA5</div>
                                    <div class="ma-box" :class="currentMetrics.ma10 ? 'ma-up' : 'ma-down'">MA10</div>
                                    <div class="ma-box" :class="currentMetrics.ma20 ? 'ma-up' : 'ma-down'">MA20</div>
                                    <div class="ma-box" :class="currentMetrics.ma60 ? 'ma-up' : 'ma-down'">MA60</div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #999;">
                                    {{ currentMetrics.trendSummary }}
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¸‹ï¼šå†å²è®°å½•åˆ—è¡¨ -->
                         <div class="chart-card analysis-right">
                             <h3 style="margin:0 0 10px 0; font-size: 16px;">ğŸ“… å†å²æ•°æ®æ¦‚è§ˆ</h3>
                             <el-table :data="historyList" style="width: 100%" height="250" size="small" stripe>
                                 <el-table-column prop="targetDate" label="æ—¥æœŸ" width="100">
                                     <template #default="scope">{{ formatDateSimple(scope.row.targetDate) }}</template>
                                 </el-table-column>
                                 <el-table-column prop="close" label="æ”¶ç›˜" width="70">
                                     <template #default="scope">{{ scope.row.close?.toFixed(3) }}</template>
                                 </el-table-column>
                                 <el-table-column prop="score" label="Score" width="70">
                                     <template #default="scope">{{ scope.row.score?.toFixed(2) }}</template>
                                 </el-table-column>
                                 <el-table-column prop="ranking" label="æ’å" width="60"></el-table-column>
                                 <el-table-column prop="rankingChange" label="å˜åŠ¨" align="right">
                                    <template #default="scope">
                                        <span :class="scope.row.rankingChange > 0 ? 'rank-up' : (scope.row.rankingChange < 0 ? 'rank-down' : '')">
                                            {{ scope.row.rankingChange }}
                                        </span>
                                    </template>
                                 </el-table-column>
                             </el-table>
                        </div>
                    </div>
                </template>

                <div v-else class="chart-card" style="height: 100%; justify-content: center; align-items: center; color: #999;">
                    <el-empty description="ğŸ‘ˆ è¯·åœ¨å·¦ä¾§åˆ—è¡¨ä¸­ç‚¹å‡»ä»»ä¸€ ETFï¼ŒæŸ¥çœ‹å¤šç»´æ·±åº¦åˆ†æ"></el-empty>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        const app = createApp({
            setup() {
                // User State
                const currentUser = ref({});
                const isAdmin = computed(() => {
                    return currentUser.value.roles && currentUser.value.roles.includes('ADMIN');
                });

                const loading = ref(false);
                const chartLoading = ref(false);
                const etfList = ref([]);
                const searchText = ref('');
                const minAmount = ref(0);
                const selectedTimeRange = ref(7); // é»˜è®¤7å¤©
                const customTimeRange = ref(7);
                const exchangeFilter = ref('');
                const currentEtf = ref(null);
                const targetDate = ref(''); // å½“å‰é€‰ä¸­çš„æ—¥æœŸ
                const stockType = ref('STOCK'); // é»˜è®¤ä¸ºè‚¡ç¥¨
                const dataStatus = ref('åˆå§‹åŒ–ä¸­...');

                // å¯¹æ¯”åŠŸèƒ½ç›¸å…³çŠ¶æ€
                const compareList = ref([]); // é€‰ä¸­çš„ ID åˆ—è¡¨
                const compareOptions = ref([]); // ä¸‹æ‹‰é€‰é¡¹
                const compareLoading = ref(false);
                const compareHistoryData = ref({}); // ç¼“å­˜å¯¹æ¯”æ•°æ®çš„å†å²è®°å½• {id: [history...]}
                const compareColorMap = ref({}); // ä¸ºæ¯ä¸ªå¯¹æ¯” ID åˆ†é…é¢œè‰²
                // ä¼˜åŒ–åçš„é«˜å¯¹æ¯”åº¦é¢œè‰²ç›˜ï¼Œæ›´é²œè‰³ï¼ŒåŒºåˆ†åº¦æ›´é«˜
                const colorPalette = [
                    '#FF0000', // é²œçº¢
                    '#0000FF', // çº¯è“
                    '#00AA00', // é²œç»¿
                    '#FF00FF', // æ´‹çº¢
                    '#FF8000', // æ©™è‰²
                    '#00FFFF', // é’è‰²
                    '#800080', // ç´«è‰²
                    '#008080', // è“ç»¿
                    '#800000', // æ·±çº¢
                    '#000080'  // æ·±è“
                ];
                
                // å¸ƒå±€æ§åˆ¶ï¼šé»˜è®¤åˆ—è¡¨å  55%
                const initialLeftWidth = window.innerWidth * 0.55;
                const leftPanelWidth = ref(initialLeftWidth);
                const isResizing = ref(false);
                const lastLeftWidth = ref(initialLeftWidth); // è®°å½•ä¸Šæ¬¡å®½åº¦ä»¥ä¾¿æ¢å¤
                const rightPanelVisible = computed(() => {
                    // å¦‚æœå·¦ä¾§é¢æ¿å®½åº¦å æ»¡äº†ï¼ˆç•™ç»™å³ä¾§çš„ç©ºé—´å¾ˆå°‘ï¼‰ï¼Œåˆ™éšè—å³ä¾§
                    // è¿™é‡Œç®€å•å¤„ç†ï¼šåªè¦å·¦ä¾§æ²¡å æ»¡ï¼Œå³ä¾§å°±æ˜¾ç¤º
                    // ä¹Ÿå¯ä»¥åè¿‡æ¥æ§åˆ¶ï¼šå½“ leftPanelWidth å¾ˆå¤§æ—¶...
                    // å®é™…ä¸Š CSS flex:1 ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†ä¸ºäº† v-show æ•ˆæœ
                    // æˆ‘ä»¬å‡è®¾æ€»å®½åº¦ä¸º window.innerWidthï¼Œå¦‚æœ leftPanelWidth > window.innerWidth - 50, åˆ™éšè—å³ä¾§
                    return true; 
                });
                
                // æ‹–æ‹½ç›¸å…³é€»è¾‘
                let animationFrameId = null;
                let lastResizeTime = 0;

                const handleMouseDown = () => {
                    isResizing.value = true;
                    // é˜²æ­¢é€‰ä¸­æ–‡å­—
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'col-resize';
                };

                const handleMouseMove = (e) => {
                    if (!isResizing.value) return;
                    
                    // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ– DOM æ›´æ–°é¢‘ç‡
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }

                    animationFrameId = requestAnimationFrame(() => {
                        // é™åˆ¶æœ€å°/æœ€å¤§å®½åº¦
                        const minWidth = 0;
                        const maxWidth = window.innerWidth - 20; // ç•™ä¸€ç‚¹ç»™å³è¾¹
                        
                        let newWidth = e.clientX;
                        if (newWidth < 50) newWidth = 0; // å¸é™„åˆ°0
                        if (newWidth > maxWidth) newWidth = maxWidth;
                        
                        leftPanelWidth.value = newWidth;
                        
                        // èŠ‚æµå›¾è¡¨ resizeï¼šæ¯ 100ms è§¦å‘ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹å¯¼è‡´å¡é¡¿
                        const now = Date.now();
                        if (myChart && (now - lastResizeTime > 100)) {
                            myChart.resize({
                                animation: { duration: 0 } // è°ƒæ•´å¤§å°æ—¶ç¦ç”¨åŠ¨ç”»ï¼Œæé«˜æ€§èƒ½
                            });
                            lastResizeTime = now;
                        }
                    });
                };

                const handleMouseUp = () => {
                    if (isResizing.value) {
                        isResizing.value = false;
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                        
                        if (animationFrameId) {
                            cancelAnimationFrame(animationFrameId);
                            animationFrameId = null;
                        }

                        // æ‹–æ‹½ç»“æŸå¼ºåˆ¶ resize ä¸€æ¬¡ï¼Œç¡®ä¿å›¾è¡¨å¤§å°æ­£ç¡®
                        // åŒæ—¶è§¦å‘è¡¨æ ¼çš„é‡ç»˜ï¼Œç¡®ä¿åˆ—å®½è‡ªé€‚åº”
                        nextTick(() => {
                            if (myChart) myChart.resize();
                            if (dataTableRef.value) {
                                dataTableRef.value.doLayout();
                            }
                        });
                    }
                };

                // åŒå‡»åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ï¼ˆå…¨å±åˆ—è¡¨ / é»˜è®¤ / å…¨å±è¯¦æƒ…ï¼‰
                // ç®€å•å¾ªç¯ï¼šé»˜è®¤ -> ä»…è¯¦æƒ…(0) -> ä»…åˆ—è¡¨(å…¨å±) -> é»˜è®¤
                const togglePanel = () => {
                    const totalWidth = window.innerWidth;
                    const defaultWidth = totalWidth * 0.55;
                    
                    if (leftPanelWidth.value > 0 && leftPanelWidth.value < totalWidth - 50) {
                        // å½“å‰æ˜¯é»˜è®¤çŠ¶æ€ -> åˆ‡æ¢åˆ°ä»…è¯¦æƒ… (Left=0)
                        lastLeftWidth.value = leftPanelWidth.value;
                        leftPanelWidth.value = 0;
                    } else if (leftPanelWidth.value === 0) {
                        // å½“å‰æ˜¯ä»…è¯¦æƒ… -> åˆ‡æ¢åˆ°ä»…åˆ—è¡¨ (Left=Total)
                        leftPanelWidth.value = totalWidth;
                    } else {
                        // å½“å‰æ˜¯ä»…åˆ—è¡¨ -> åˆ‡æ¢å›ä¸Šæ¬¡çš„é»˜è®¤å®½åº¦
                        leftPanelWidth.value = lastLeftWidth.value || defaultWidth;
                    }
                    
                    nextTick(() => {
                         if (myChart) myChart.resize();
                         if (dataTableRef.value) {
                             dataTableRef.value.doLayout();
                         }
                    });
                };

                // çŠ¶æ€å˜é‡
                const chartMetric = ref('score'); 
                const dataTableRef = ref(null);  
                const quickTimeRange = ref(90); 
                const historyList = ref([]); // å½“å‰é€‰ä¸­ ETF çš„å†å²æ•°æ®

                // é‡åŒ–æŒ‡æ ‡æ•°æ®
                const currentMetrics = ref({
                    drawdown: 0,
                    highPrice: 0,
                    isUpTrend: false,
                    ma5: false, ma10: false, ma20: false, ma60: false,
                    trendSummary: '-'
                });

                let myChart = null;

                // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    return d.toISOString().split('T')[0];
                };

                const formatDateSimple = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                // è·å–æœ€æ–°çš„æ•°æ®æ—¥æœŸ
                const fetchCurrentUser = async () => {
                    try {
                        const res = await axios.get('/api/me');
                        currentUser.value = res.data;
                    } catch (e) {
                        console.error("Failed to fetch user info", e);
                    }
                };

                const fetchLatestData = async () => {
                    loading.value = true;
                    dataStatus.value = 'åŠ è½½æœ€æ–°æ•°æ®...';
                    try {
                        // å°è¯•ç›´æ¥è·å– /latestï¼Œå¹¶å¸¦ä¸Šå½“å‰é€‰ä¸­çš„ stockType å’Œ timeRange
                        let timeRangeVal = 7;
                        if (selectedTimeRange.value === 'custom') {
                            timeRangeVal = customTimeRange.value;
                        } else {
                            timeRangeVal = selectedTimeRange.value;
                        }

                        const response = await axios.get('/api/stock-analysis/latest', {
                            params: { 
                                stockType: stockType.value,
                                timeRange: timeRangeVal
                            }
                        });
                        
                        etfList.value = []; // å…ˆæ¸…ç©ºï¼Œé¿å…æ•°æ®æ®‹ç•™
                        
                        if (response.data && response.data.length > 0) {
                            etfList.value = response.data;
                            // ä»ç¬¬ä¸€æ¡æ•°æ®è·å–æ—¥æœŸ
                            if (etfList.value[0].targetDate) {
                                targetDate.value = formatDateSimple(etfList.value[0].targetDate);
                            }
                            dataStatus.value = 'åœ¨çº¿';
                        } else {
                            dataStatus.value = 'æ— æ•°æ®';
                            targetDate.value = ''; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ¸…ç©ºæ—¥æœŸ
                            // ä½¿ç”¨ Element Plus çš„æ¶ˆæ¯æç¤º
                            if (window.ElementPlus) {
                                ElementPlus.ElMessage.warning('è¯¥åˆ†ç±»ä¸‹æš‚æ— æœ€æ–°æ•°æ®');
                            }
                        }
                    } catch (error) {
                        console.error('Fetch latest failed', error);
                        dataStatus.value = 'è¿æ¥å¤±è´¥';
                        document.getElementById('error-msg').innerText = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥: ' + error.message;
                        document.getElementById('error-msg').style.display = 'block';
                    } finally {
                        loading.value = false;
                    }
                };

                // æ ¹æ®æ—¥æœŸè·å–æ•°æ®
                const fetchData = async () => {
                    if (!targetDate.value) return;
                    loading.value = true;
                    try {
                        const params = { 
                            targetDate: targetDate.value,
                            stockType: stockType.value 
                        };
                        
                        if (minAmount.value > 0) {
                            params.minAmount = minAmount.value; // åç«¯ä¼šè‡ªåŠ¨ä¹˜ä»¥10000
                        }
                        
                        // å¤„ç†æ—¶é—´èŒƒå›´å‚æ•°
                        if (selectedTimeRange.value === 'custom') {
                            params.timeRange = customTimeRange.value;
                        } else {
                            params.timeRange = selectedTimeRange.value;
                        }

                        const response = await axios.get('/api/stock-analysis/search', { params });
                        etfList.value = response.data;
                    } catch (error) {
                        console.error('Fetch data failed', error);
                         this.$message.error('è·å–æ•°æ®å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };

                // ç›‘å¬ minAmount å˜åŒ–ï¼Œé˜²æŠ–åè§¦å‘æŸ¥è¯¢
                let debounceTimer = null;
                watch([minAmount, selectedTimeRange, customTimeRange], () => {
                    if (debounceTimer) clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        fetchData();
                    }, 1000);
                });
                
                const handleTimeRangeChange = () => {
                    if (selectedTimeRange.value !== 'custom') {
                        fetchData();
                    }
                };

                // è¿œç¨‹æœç´¢å¯¹æ¯”è‚¡ç¥¨
                const remoteSearchCompare = (query) => {
                    if (query) {
                        compareLoading.value = true;
                        setTimeout(() => {
                            compareLoading.value = false;
                            // ä»å·²æœ‰çš„ etfList ä¸­æœç´¢ (å‡è®¾å·²åŠ è½½å…¨é‡æœ€æ–°æ•°æ®)
                            // å¦‚æœ etfList æ•°æ®é‡å¤§ï¼Œè¿™é‡Œæ˜¯å…¨é‡æœç´¢ã€‚
                            // å¦‚æœéœ€è¦æœåº“ï¼Œéœ€è°ƒç”¨åç«¯ search æ¥å£ã€‚é‰´äºå½“å‰ latest å·²ç»æ‹‰å–äº†åˆ—è¡¨ï¼Œç›´æ¥å‰ç«¯æœã€‚
                            compareOptions.value = etfList.value.filter(item => {
                                return item.instrumentName.includes(query) || item.instrumentId.includes(query);
                            });
                        }, 200);
                    } else {
                        compareOptions.value = [];
                    }
                };

                // å¤„ç†å¯¹æ¯”é€‰æ‹©å˜æ›´
                const handleCompareChange = async (val) => {
                    // val æ˜¯ ID æ•°ç»„
                    // 1. æ‰¾å‡ºæ–°å¢çš„ ID
                    const newIds = val.filter(id => !compareHistoryData.value[id]);
                    
                    // 2. æ‰¾å‡ºç§»é™¤çš„ IDï¼Œæ¸…ç†ç¼“å­˜
                    Object.keys(compareHistoryData.value).forEach(id => {
                        if (!val.includes(id)) {
                            delete compareHistoryData.value[id];
                            delete compareColorMap.value[id];
                        }
                    });

                    // 3. ä¸ºæ–°å¢ ID åˆ†é…é¢œè‰²å¹¶è·å–æ•°æ®
                    for (const id of newIds) {
                        // åˆ†é…é¢œè‰²
                        const colorIndex = Object.keys(compareColorMap.value).length % colorPalette.length;
                        compareColorMap.value[id] = colorPalette[colorIndex];
                        
                        // è·å–æ•°æ® (éœ€è¦çŸ¥é“ exchangeIdï¼Œä» etfList æˆ– compareOptions æ‰¾)
                        let target = etfList.value.find(item => item.instrumentId === id);
                        if (!target && compareOptions.value) {
                             target = compareOptions.value.find(item => item.instrumentId === id);
                        }
                        
                        if (target) {
                            await fetchCompareHistory(target.exchangeId, target.instrumentId);
                        }
                    }
                    
                    updateChart();
                };

                const handleRemoveCompare = (tag) => {
                    // tag æ˜¯è¢«ç§»é™¤çš„ ID
                    // å®é™…ä¸Š handleCompareChange ä¼šè¢«è§¦å‘ï¼Œè¿™é‡Œå¯èƒ½ redundantï¼Œä½† Element Plus æ–‡æ¡£å»ºè®® handle change
                };

                // è·å–å¯¹æ¯”æ•°æ®çš„å†å²
                const fetchCompareHistory = async (exchangeId, instrumentId) => {
                    try {
                        const response = await axios.get('/api/stock-analysis/search', {
                            params: { exchangeId, instrumentId }
                        });
                        // å­˜å…¥ç¼“å­˜
                        compareHistoryData.value[instrumentId] = response.data;
                    } catch (error) {
                        console.error('Fetch compare history failed', error);
                    }
                };

                // è·å–å•ä¸ª ETF çš„å†å²æ•°æ®
                const fetchHistory = async (exchangeId, instrumentId) => {
                    chartLoading.value = true;
                    try {
                        const response = await axios.get('/api/stock-analysis/search', {
                            params: { 
                                exchangeId, 
                                instrumentId 
                            }
                        });
                        // æŒ‰æ—¥æœŸæ’åº
                        const data = response.data.sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
                        historyList.value = [...data].reverse(); // åˆ—è¡¨æ˜¾ç¤ºå€’åºï¼Œä½¿ç”¨å‰¯æœ¬ä¸å½±å“åŸæ•°æ®
                        
                        // è®¡ç®—æŒ‡æ ‡å¹¶ç»˜å›¾ï¼ˆä½¿ç”¨æ­£åºæ•°æ®ï¼‰
                        updateChartAndMetrics(data);
                    } catch (error) {
                        console.error('Fetch history failed', error);
                    } finally {
                        chartLoading.value = false;
                    }
                };

                const filteredList = computed(() => {
                    return etfList.value.filter(item => {
                        const matchText = !searchText.value || 
                            item.instrumentId.includes(searchText.value) || 
                            item.instrumentName.includes(searchText.value);
                        // é‡‘é¢è¿‡æ»¤å·²ç§»è‡³åç«¯
                        const matchEx = !exchangeFilter.value || item.exchangeId === exchangeFilter.value;
                        
                        return matchText && matchEx;
                    });
                });

                // è®¡ç®— MA
                const calculateMA = (data, dayCount) => {
                    const result = [];
                    for (let i = 0; i < data.length; i++) {
                        if (i < dayCount - 1) {
                            result.push(null);
                            continue;
                        }
                        let sum = 0;
                        for (let j = 0; j < dayCount; j++) {
                            sum += data[i - j].close;
                        }
                        result.push(sum / dayCount);
                    }
                    return result;
                };

                const updateChartAndMetrics = (fullHistory) => {
                    // 0. å¼ºåˆ¶ç¡®ä¿æ•°æ®æŒ‰æ—¥æœŸæ­£åºæ’åˆ— (æ—§ -> æ–°)
                    fullHistory.sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));

                    // 1. è¿‡æ»¤æ—¶é—´èŒƒå›´
                    let endDate = new Date();
                    if (targetDate.value) {
                         // å¦‚æœæœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œä½¿ç”¨é€‰ä¸­æ—¥æœŸä½œä¸ºç»“æŸæ—¥æœŸ
                        endDate = new Date(targetDate.value);
                    }
                    
                    const startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - quickTimeRange.value);

                    // ç­›é€‰ [startDate, endDate] èŒƒå›´å†…çš„æ•°æ®
                    // æ³¨æ„ï¼šfullHistory ä¸­çš„ targetDate å¯èƒ½æ˜¯ UTC å­—ç¬¦ä¸²ï¼Œæ¯”è¾ƒæ—¶éœ€è½¬ Date
                    const data = fullHistory.filter(item => {
                        const d = new Date(item.targetDate);
                        // åªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶åˆ†ç§’å·®å¼‚ (ç®€å•å¤„ç†: è½¬æ—¶é—´æˆ³æ¯”è¾ƒ)
                        return d.getTime() >= startDate.getTime() && d.getTime() <= endDate.getTime() + 86400000; // +1å¤©ä»¥åŒ…å«å½“å¤©
                    });
                    
                    if (data.length === 0) return;

                    const dates = data.map(item => formatDateSimple(item.targetDate));
                    const prices = data.map(item => item.close);
                    
                    // 2. è®¡ç®—æŒ‡æ ‡
                    const maxPrice = Math.max(...prices);
                    const currentPrice = prices[prices.length - 1];
                    const drawdown = ((currentPrice - maxPrice) / maxPrice * 100);
                    
                    // ç®€å• MA è®¡ç®— (åŸºäºå®Œæ•´å†å²ä»¥ä¿è¯å‡†ç¡®æ€§ï¼Œç„¶åæˆªå–)
                    // ... (rest of the function)
                    const closes = fullHistory.map(d => d.close);
                    const ma5Full = calculateMA(fullHistory, 5);
                    const ma10Full = calculateMA(fullHistory, 10);
                    const ma20Full = calculateMA(fullHistory, 20);
                    const ma60Full = calculateMA(fullHistory, 60);

                    // è·å–æœ€åä¸€ä¸ªç‚¹çš„çŠ¶æ€
                    const lastIdx = fullHistory.length - 1;
                    const lastClose = closes[lastIdx];
                    
                    currentMetrics.value = {
                        drawdown: drawdown, // ä¿æŒåŸå§‹å€¼ï¼Œæ˜¾ç¤ºæ—¶æ ¼å¼åŒ–
                        highPrice: maxPrice, // ä¿æŒåŸå§‹å€¼
                        isUpTrend: (ma20Full[lastIdx] > ma60Full[lastIdx]), // ç®€å•å®šä¹‰
                        ma5: lastClose > ma5Full[lastIdx],
                        ma10: lastClose > ma10Full[lastIdx],
                        ma20: lastClose > ma20Full[lastIdx],
                        ma60: lastClose > ma60Full[lastIdx],
                        trendSummary: (lastClose > ma20Full[lastIdx] && ma20Full[lastIdx] > ma60Full[lastIdx]) ? 'å¤šå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸Š' : 'è¶‹åŠ¿éœ‡è¡æˆ–å›è°ƒä¸­'
                    };

                    // 3. ç»˜å›¾æ•°æ®å‡†å¤‡
                    const metricMap = {
                        'score': { name: 'åŠ¨é‡å¾—åˆ†', data: data.map(i => i.score), color: '#f59e0b', inverse: false, type: 'line', area: true },
                        'ranking': { name: 'å…¨å¸‚åœºæ’å', data: data.map(i => i.ranking), color: '#ef4444', inverse: true, type: 'line', area: false }, 
                        'amount': { name: 'æˆäº¤é‡‘é¢', data: data.map(i => i.amount), color: '#3b82f6', inverse: false, type: 'bar', area: false }
                    };
                    const selected = metricMap[chartMetric.value];

                    const option = {
                        title: { text: `${dates[0]} è‡³ ${dates[dates.length-1]} è¶‹åŠ¿åˆ†æ`, left: 'left', textStyle: { fontSize: 16, color: '#374151', fontWeight: 'bold' } },
                        tooltip: { 
                            trigger: 'axis', 
                            axisPointer: { type: 'line', lineStyle: { type: 'dashed' } },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#e5e7eb',
                            textStyle: { color: '#1f2937' },
                            extraCssText: 'box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 8px;'
                        },
                        grid: { right: '80', left: '60', bottom: '40', top: '60' },
                        legend: { 
                            data: ['æ”¶ç›˜ä»·', selected.name], 
                            bottom: 0,
                            icon: 'circle',
                            textStyle: { color: '#6b7280' }
                        },
                        xAxis: { 
                            type: 'category', 
                            data: dates, 
                            axisLine: { lineStyle: { color: '#e5e7eb' } },
                            axisLabel: { color: '#6b7280' },
                            axisTick: { show: false }
                        },
                        yAxis: [
                            { 
                                type: 'log', name: 'æ”¶ç›˜ä»·', position: 'left', scale: true, 
                                splitLine: { show: true, lineStyle: { type: 'dashed', color: '#f3f4f6' } }, 
                                logBase: 10,
                                axisLine: { show: false },
                                axisLabel: { color: '#6b7280' },
                                nameTextStyle: { color: '#9ca3af' }
                            },
                            { 
                                type: 'value', name: selected.name, position: 'right', scale: true, inverse: selected.inverse, 
                                axisLine: { show: false }, 
                                axisLabel: { color: selected.color, fontWeight: 'bold' }, 
                                splitLine: { show: false },
                                nameTextStyle: { color: selected.color }
                            }
                        ],
                        series: [
                            { 
                                name: 'æ”¶ç›˜ä»·', type: 'line', data: prices, yAxisIndex: 0, showSymbol: false, 
                                itemStyle: { color: '#111827' }, 
                                lineStyle: { width: 3, shadowColor: 'rgba(0,0,0,0.1)', shadowBlur: 10 },
                                smooth: true
                            },
                            { 
                                name: selected.name, type: selected.type, data: selected.data, yAxisIndex: 1, showSymbol: false, 
                                itemStyle: { color: selected.color }, 
                                lineStyle: { width: 2 },
                                smooth: true,
                                areaStyle: selected.area ? { 
                                    opacity: 0.3,
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: selected.color },
                                        { offset: 1, color: 'rgba(255, 255, 255, 0)' }
                                    ])
                                } : null 
                            }
                        ]
                    };

                    // æ·»åŠ å¯¹æ¯”ç³»åˆ—
                    if (compareList.value && compareList.value.length > 0) {
                        compareList.value.forEach(id => {
                            const compHistory = compareHistoryData.value[id];
                            if (!compHistory) return;

                            // éœ€è¦å¯¹é½æ—¥æœŸã€‚ç®€å•å¤„ç†ï¼šåˆ›å»ºä¸€ä¸ª map date -> value
                            // æ³¨æ„ï¼šcompHistory å¯èƒ½æ˜¯ä¹±åºçš„ï¼Œå…ˆæ’ä¸€ä¸‹
                            const sortedComp = [...compHistory].sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
                            
                            // æ„å»ºæ•°æ®æ˜ å°„
                            const priceMap = {};
                            const metricMapData = {};
                            sortedComp.forEach(item => {
                                const dStr = formatDateSimple(item.targetDate);
                                priceMap[dStr] = item.close;
                                metricMapData[dStr] = item[chartMetric.value]; // score, ranking, amount
                            });

                            // æŒ‰ç…§ä¸»å›¾è¡¨çš„ dates å¯¹é½æ•°æ®
                            const alignedPrices = dates.map(d => priceMap[d] !== undefined ? priceMap[d] : null);
                            const alignedMetric = dates.map(d => metricMapData[d] !== undefined ? metricMapData[d] : null);

                            // è·å–åç§° (ä» etfList æˆ– compareOptions æ‰¾)
                            let name = id;
                            const target = etfList.value.find(i => i.instrumentId === id) || (compareOptions.value ? compareOptions.value.find(i => i.instrumentId === id) : null);
                            if (target) name = target.instrumentName;

                            const color = compareColorMap.value[id] || '#999';

                            // æ·»åŠ  Price Series (Left Axis) - è™šçº¿
                            option.series.push({
                                name: `${name} (ä»·)`,
                                type: 'line',
                                data: alignedPrices,
                                yAxisIndex: 0,
                                showSymbol: false,
                                itemStyle: { color: color },
                                lineStyle: { width: 2.5, type: 'dashed' },
                                tooltip: { valueFormatter: (value) => value ? value.toFixed(3) : '-' }
                            });
                            option.legend.data.push(`${name} (ä»·)`);

                            // æ·»åŠ  Metric Series (Right Axis) - ç‚¹çº¿æˆ–å…¶ä»–æ ·å¼
                            // ä¸ºäº†åŒºåˆ†ï¼Œå¯¹æ¯”çš„ Metric ç”¨ç‚¹çº¿ï¼Œæˆ–è€…æ›´ç»†çš„å®çº¿ï¼Ÿ
                            // è€ƒè™‘åˆ° ranking æ˜¯ inverse çš„ï¼Œå¦‚æœæ˜¯ ranking æ¨¡å¼ï¼Œå¯¹æ¯”ä¹Ÿè¦ inverse (å·²ç»ç”± yAxis æ§åˆ¶)
                            option.series.push({
                                name: `${name} (${selected.name})`,
                                type: 'line',
                                data: alignedMetric,
                                yAxisIndex: 1,
                                showSymbol: false,
                                itemStyle: { color: color },
                                lineStyle: { width: 2.5, type: 'dotted' },
                                areaStyle: null
                            });
                            option.legend.data.push(`${name} (${selected.name})`);
                        });
                    }
                    
                    if (myChart) {
                        myChart.setOption(option, true); // true = not merge, reset
                    }
                };

                const updateChart = () => {
                   // è§¦å‘é‡æ–°ç»˜å›¾ï¼ˆåˆ©ç”¨å·²æœ‰æ•°æ®ï¼‰
                   // è¿™é‡Œéœ€è¦ç¼“å­˜ fetchHistory çš„æ•°æ®ï¼Œæš‚ç•¥ï¼Œç®€å•èµ·è§é‡æ–° fetch æˆ– ä¾èµ– historyList
                   // ä¸ºç®€å•èµ·è§ï¼Œä» historyList (å€’åº) æ¢å¤æ­£åºå¹¶é‡ç»˜
                   if (historyList.value.length > 0) {
                       // ç›´æ¥ä¼ é€’ï¼ŒupdateChartAndMetrics å†…éƒ¨ä¼šå¼ºåˆ¶æŒ‰æ—¥æœŸæ­£åºæ’åˆ—
                       updateChartAndMetrics(historyList.value);
                   }
                };

                const handleQuickTimeChange = () => {
                    updateChart();
                };

                const handleRowClick = (row) => {
                    currentEtf.value = row;
                    fetchHistory(row.exchangeId, row.instrumentId);

                    nextTick(() => {
                        if (!myChart) {
                            myChart = echarts.init(document.getElementById('trendChart'));
                            window.addEventListener('resize', () => myChart.resize());
                        }
                    });
                };

                const disabledDate = (time) => {
                    return time.getTime() > Date.now();
                }

                onMounted(() => {
                    fetchCurrentUser();
                    fetchLatestData();
                });

                return {
                    currentUser, isAdmin,
                    loading, chartLoading, etfList, filteredList, searchText, minAmount, exchangeFilter, currentEtf,
                    chartMetric, quickTimeRange, targetDate, dataStatus, stockType,
                    currentMetrics, historyList, dataTableRef,
                    handleRowClick, updateChart, handleQuickTimeChange, fetchData, fetchLatestData, disabledDate, formatDateSimple,
                    leftPanelWidth, isResizing, handleMouseDown, handleMouseMove, handleMouseUp, togglePanel, rightPanelVisible,
                    compareList, compareOptions, compareLoading, remoteSearchCompare, handleCompareChange, handleRemoveCompare,
                    selectedTimeRange, customTimeRange, handleTimeRangeChange
                };
            }
        });

        app.use(ElementPlus, { locale: ElementPlusLocaleZhCn }); 
        app.mount('#app');
    </script>
</body>
</html>

